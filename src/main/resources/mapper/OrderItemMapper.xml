<mapper namespace="com.cloneproject.demo.orderItem.repository.OrderItemRepository">

  <select id="findByOrderId" resultType="OrderItem">
    SELECT * FROM order_item WHERE order_id = #{orderId} ORDER BY sequence
  </select>

  <select id="searchByProductName" resultType="OrderItem">
    SELECT oi.* FROM order_item oi
    JOIN order_group og ON oi.order_id = og.id
    WHERE og.member_id = #{memberId}
    AND oi.product_name LIKE CONCAT('%', #{keyword}, '%')
  </select>

  <update id="updateStatus">
    UPDATE order_item
    SET status = #{status}, updated_at = NOW(), status_changed_date = NOW()
    WHERE id = #{id}
  </update>

  <update id="updateStatusChangedDate">
    UPDATE order_item
    SET status_changed_date = NOW()
    WHERE id = #{id}
  </update>

  <delete id="deleteById">
    DELETE FROM order_item
    WHERE id = #{id}
  </delete>

  <update id="autoUpdateConfirmed">
    UPDATE order_item
    SET status = '구매확정', updated_at = NOW()
    WHERE status = '배송완료'
    AND status_changed_date <= DATE_SUB(NOW(), INTERVAL 7 DAY)
  </update>

</mapper>